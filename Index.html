<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Demo Script Generator</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <style>
    body, input, textarea, button { font-family: 'Roboto', 'Arial', sans-serif; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .nav-link { padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
    .nav-link.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 500; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 2rem; display: flex; align-items: center;}
    .prose h3 { font-size: 1.25rem; font-weight: 600; color: #0284c7; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.75rem; margin-top: 2.5rem; margin-bottom: 1.5rem; }
    .prose p { margin-bottom: 1rem; line-height: 1.6; }
    .prose p.label-paragraph { margin-bottom: 0.25rem; }
    .prose p.label-paragraph > strong { display: inline-flex; align-items: center; font-size: 0.875rem; font-weight: 600; color: #334155; text-transform: uppercase; letter-spacing: 0.05em; }
    .prose p.label-paragraph > strong::before { font-family: 'Material Symbols Outlined'; font-size: 1.25rem; margin-right: 0.5rem; font-weight: 400; }
    .action-block > strong::before { content: 'build'; color: #b91c1c; }
    .ui-interaction-block > strong::before { content: 'mouse'; color: #16a34a; }
    .presenter-script-block > strong::before { content: 'record_voice_over'; color: #ca8a04; }
    .content-block { padding: 1rem; margin-top: 0; margin-bottom: 1.2rem; border-radius: 0 0.375rem 0.375rem 0; font-style: normal; }
    .content-block p { margin-bottom: 0; line-height: 1.4; }
    .prose code { color: #be123c; font-weight: 600; font-size: 0.875em; }
    .action-block + .content-block { background-color: #fef2f2; border-left: 4px solid #fca5a5; color: #991b1b; }
    .ui-interaction-block + .content-block { background-color: #f0fdf4; border-left: 4px solid #86efac; color: #166534; }
    .presenter-script-block + .content-block { background-color: #fefce8; border-left: 4px solid #fde047; color: #854d0e; }
    .presenter-script-block + .content-block em { color: #713f12; font-style: italic; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-3">
          <span class="material-symbols-outlined text-3xl text-blue-600">auto_awesome</span>
          <h1 class="text-xl font-semibold text-slate-700">Demo Script Generator</h1>
        </div>
        <nav class="hidden lg:flex items-center space-x-2">
          <a id="navLinkAccount" class="nav-link text-slate-700 hover:bg-gray-100">Demo Account</a>
          <a id="navLinkGenerator" class="nav-link text-slate-700 hover:bg-gray-100">Generate Demo</a>
        </nav>
        <div class="lg:hidden flex items-center">
            <button id="hamburgerButton" class="p-2 rounded-md text-slate-500 hover:text-slate-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                <span class="sr-only">Open main menu</span>
                <span class="material-symbols-outlined">menu</span>
            </button>
        </div>
      </div>
    </div>
    <div id="mobileMenu" class="lg:hidden hidden border-t border-gray-200">
        <div class="px-2 pt-2 pb-3 space-y-1">
            <a id="mobileNavLinkAccount" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-slate-700 hover:bg-gray-50 nav-link">Demo Account</a>
            <a id="mobileNavLinkGenerator" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-slate-700 hover:bg-gray-50 nav-link">Generate Demo</a>
        </div>
    </div>
  </header>
  
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="max-w-4xl mx-auto">
      
      <section id="accountSection">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 prose max-w-none">
          <h2 class="!mt-0"><span class="material-symbols-outlined mr-3 text-blue-600 text-3xl">badge</span>Demo Account</h2>
          
          <div id="userCreationForm" class="hidden">
             <p class="text-slate-600">Enter a name for the demo persona. A new Google Workspace account will be provisioned based on the current user's email address.</p>
             <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 my-6">
                <div>
                  <label for="userFirstNameInput" class="block text-sm font-medium text-slate-700 mb-1">First Name</label>
                  <input type="text" id="userFirstNameInput" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 placeholder-slate-400" placeholder="e.g., Alex">
                </div>
                <div>
                  <label for="userLastNameInput" class="block text-sm font-medium text-slate-700 mb-1">Last Name</label>
                  <input type="text" id="userLastNameInput" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 placeholder-slate-400" placeholder="e.g., Wilton">
                </div>
             </div>
             <button id="createUserBtn" type="button" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <span class="material-symbols-outlined mr-2">person_add</span>Create Demo Account
             </button>
          </div>

          <div id="userCredentialsDisplay" class="hidden">
             <p class="text-slate-600">Your demo account is ready. Use this account for the demo by opening a new Incognito window to log in.</p>
             <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-y-4">
               <div>
                 <label class="block text-xs font-medium text-slate-500">First Name</label>
                 <strong id="userFirstNameDisplay" class="text-slate-800"></strong>
               </div>
               <div>
                 <label class="block text-xs font-medium text-slate-500">Last Name</label>
                 <strong id="userLastNameDisplay" class="text-slate-800"></strong>
               </div>
               <div><label class="block text-xs font-medium text-slate-500">Email</label><div class="flex items-center justify-between"><strong id="userEmail" class="text-slate-800 break-all"></strong><button onclick="copyToClipboard(document.getElementById('userEmail').textContent, this)" class="ml-2 p-1 text-slate-500 hover:text-blue-600" title="Copy Email"><span class="material-symbols-outlined text-sm">content_copy</span></button></div></div>
               <div><label class="block text-xs font-medium text-slate-500">Password</label><div class="flex items-center justify-between"><strong id="userPassword" class="text-slate-800 font-mono"></strong><button onclick="copyToClipboard(document.getElementById('userPassword').textContent, this)" class="ml-2 p-1 text-slate-500 hover:text-blue-600" title="Copy Password"><span class="material-symbols-outlined text-sm">content_copy</span></button></div></div>
             </div>
             <div id="resetPasswordContainer" class="hidden mt-4">
                <p class="text-sm text-slate-500">Forgot the password? You can reset it to get a new one.</p>
                <button id="resetPasswordBtn" type="button" class="mt-2 flex items-center justify-center px-4 py-2 border border-yellow-400 text-sm font-medium rounded-md shadow-sm text-yellow-800 bg-yellow-100 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                  <span class="material-symbols-outlined mr-2">lock_reset</span>Reset Password
                </button>
             </div>
             <div class="mt-4">
                 <button id="deleteAccountBtn" type="button" class="mt-2 flex items-center justify-center px-4 py-2 border border-red-400 text-sm font-medium rounded-md shadow-sm text-red-800 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                   <span class="material-symbols-outlined mr-2">person_remove</span>Delete Account
                 </button>
             </div>

             <div class="mt-5 pt-4 border-t border-gray-200"><a href="https://mail.google.com" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 hover:underline font-medium">Log in to Google Workspace</a></div>
          </div>
        </div>
      </section>

      <section id="generatorSection" class="hidden">
        <div id="startOverContainer" class="text-center mb-8 hidden">
          <button id="startOverBtn" type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
            <span class="material-symbols-outlined mr-2">refresh</span>Start a New Script
          </button>
        </div>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 prose max-w-none">
            <h2 class="!mt-0"><span class="material-symbols-outlined mr-3 text-blue-600 text-3xl">smart_toy</span>Generate Demo Script</h2>
            <p id="generatorInstruction" class="text-slate-600">Describe your demo objective below to generate a script.</p>

            <div id="scriptLoadingIndicator" class="hidden text-center my-10 p-6">
                <div class="animate-spin w-8 h-8 border-4 border-gray-200 border-t-blue-600 rounded-full mx-auto mb-4"></div>
                <p class="text-md font-medium text-slate-600 mt-2">AI is writing your script...</p>
            </div>

            <div id="demoConfigForm" class="mt-6">
                <label for="demoContext" class="block text-sm font-medium text-slate-700 mb-1">Demo Objective / Customer Context:</label>
                <textarea id="demoContext" rows="5" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 placeholder-slate-400" placeholder="e.g., Showcase how Gemini in Gmail and Docs can help a sales team save time creating proposals and responding to RFPs."></textarea>
                <button id="generateBtn" type="button" class="mt-6 w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span class="material-symbols-outlined mr-2">rocket_launch</span>Generate Demo Script
                </button>
            </div>

            <div id="scriptResultDisplay" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="!m-0">Your Generated Script</h3>
                    <button id="copyScriptBtn" class="flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md shadow-sm text-slate-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ml-auto"><span class="material-symbols-outlined mr-1.5 text-sm">content_paste</span>Copy Script</button>
                </div>
                <div id="scriptContent" class="prose max-w-none"><p class="text-slate-400">Your generated script will appear here...</p></div>
            </div>
        </div>
      </section>

      <div id="loadingIndicator" class="hidden text-center my-10 p-6">
        <div class="animate-spin w-12 h-12 border-4 border-gray-200 border-t-blue-600 rounded-full mx-auto mb-4"></div>
        <p id="loadingStatus" class="text-lg font-medium text-slate-600 mt-2">Initializing...</p>
      </div>

      <div id="errorDisplay" class="hidden my-6 p-4 bg-red-50 border-l-4 border-red-400 rounded-md shadow">
        <div class="flex">
          <div class="flex-shrink-0"><span class="material-symbols-outlined text-red-500">error</span></div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-700">Oops! Something went wrong.</h3>
            <p id="errorMessage" class="mt-1 text-sm text-red-600"></p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Element References ---
    const accountSectionEl = document.getElementById('accountSection');
    const generatorSectionEl = document.getElementById('generatorSection');
    const userCreationFormEl = document.getElementById('userCreationForm');
    const userCredentialsDisplayEl = document.getElementById('userCredentialsDisplay');
    const userFirstNameInputEl = document.getElementById('userFirstNameInput');
    const userLastNameInputEl = document.getElementById('userLastNameInput');
    const createUserBtnEl = document.getElementById('createUserBtn');
    const userEmailEl = document.getElementById('userEmail');
    const userPasswordEl = document.getElementById('userPassword');
    const userFirstNameDisplayEl = document.getElementById('userFirstNameDisplay');
    const userLastNameDisplayEl = document.getElementById('userLastNameDisplay');
    const resetPasswordContainerEl = document.getElementById('resetPasswordContainer');
    const deleteAccountBtnEl = document.getElementById('deleteAccountBtn');
    const resetPasswordBtnEl = document.getElementById('resetPasswordBtn');
    const generatorInstructionEl = document.getElementById('generatorInstruction');
    const demoConfigFormEl = document.getElementById('demoConfigForm');
    const demoContextInputEl = document.getElementById('demoContext');
    const generateBtnEl = document.getElementById('generateBtn');
    const scriptResultDisplayEl = document.getElementById('scriptResultDisplay');
    const scriptContentEl = document.getElementById('scriptContent');
    const scriptLoadingIndicatorEl = document.getElementById('scriptLoadingIndicator');
    const copyScriptBtnEl = document.getElementById('copyScriptBtn');
    const loadingIndicatorEl = document.getElementById('loadingIndicator');
    const loadingStatusEl = document.getElementById('loadingStatus');
    const errorDisplayEl = document.getElementById('errorDisplay');
    const errorMessageEl = document.getElementById('errorMessage');
    const startOverContainerEl = document.getElementById('startOverContainer');
    const hamburgerButton = document.getElementById('hamburgerButton');
    const mobileMenu = document.getElementById('mobileMenu');
    const navLinks = {
      account: [document.getElementById('navLinkAccount'), document.getElementById('mobileNavLinkAccount')],
      generator: [document.getElementById('navLinkGenerator'), document.getElementById('mobileNavLinkGenerator')]
    };

    // --- State & Initial Load ---
    window.addEventListener('load', loadInitialState);
    
    function loadInitialState() {
      showView('loading');
      updateLoadingStatus('Checking for your demo account...');
      google.script.run
        .withSuccessHandler(result => {
          hideError();
          if (result && result.success) {
            // A demo account already exists for this user.
            populateUserCredentials(result.provisionResult);
            
            // Check if there's a script and set up the generator view accordingly
            if (result.demoScript) {
              renderScriptFromObject(result.demoScript);
              showGeneratorView('results');
            } else {
              showGeneratorView('form');
            }
            
            // Show the account section first, so the user sees their credentials
            showView('account'); 
          } else {
            // No demo account exists. Show the creation form.
            resetUi();
          }
        })
        .withFailureHandler(onFailure)
        .getInitialAppState(); // Call the new server function
    }
    
    // --- Event Listeners ---
    createUserBtnEl.addEventListener('click', handleCreateUser);
    generateBtnEl.addEventListener('click', handleGenerateScript);
    resetPasswordBtnEl.addEventListener('click', handleResetPassword);
    deleteAccountBtnEl.addEventListener('click', handleDeleteAccount);
    copyScriptBtnEl.addEventListener('click', () => copyScriptToClipboard(copyScriptBtnEl));
    hamburgerButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
    document.getElementById('startOverBtn').addEventListener('click', handleStartOver);
    navLinks.account.forEach(el => el.addEventListener('click', () => showView('account')));
    navLinks.generator.forEach(el => el.addEventListener('click', () => showView('generator')));

    // --- Core Logic Functions ---
    function handleCreateUser() {
      hideError();
      const firstName = userFirstNameInputEl.value.trim();
      const lastName = userLastNameInputEl.value.trim();
      if (!firstName || !lastName) {
        return showError("Please enter a first and last name for the demo user.");
      }
      
      showView('loading');
      updateLoadingStatus("Provisioning demo account...");
      google.script.run
        .withSuccessHandler(result => {
          if (!result || !result.success) {
            return onFailure(result.error || "An unknown error occurred during user creation.");
          }
          populateUserCredentials(result);
          showGeneratorView('form');
          showView('account'); // Stay on account view to show credentials
        })
        .withFailureHandler(onFailure)
        .createUser({ firstName, lastName });
    }

    function handleGenerateScript() {
      hideError();
      const context = demoContextInputEl.value.trim();
      if (!context) {
        return showError("Please enter a demo objective.");
      }

      showGeneratorView('loading');
      google.script.run
        .withSuccessHandler(result => {
          if (!result || !result.success) {
            showGeneratorView('form');
            return showError(result.error || "The AI failed to generate a script. Please try again.");
          }
          renderScriptFromObject(result.demoScript);
          showGeneratorView('results');
        })
        .withFailureHandler(onFailure)
        .generateDemoScript(context);
    }

    function handleResetPassword() {
        hideError();
        const originalText = resetPasswordBtnEl.innerHTML;
        resetPasswordBtnEl.innerHTML = '<div class="animate-spin w-5 h-5 border-2 border-gray-400 border-t-yellow-600 rounded-full mx-auto"></div>';
        resetPasswordBtnEl.disabled = true;

        google.script.run
            .withSuccessHandler(response => {
                if (response && response.success) {
                    userPasswordEl.textContent = response.password;
                    resetPasswordContainerEl.classList.add('hidden');
                } else {
                    showError(response.error || 'Failed to reset password.');
                }
                resetPasswordBtnEl.innerHTML = originalText;
                resetPasswordBtnEl.disabled = false;
            })
            .withFailureHandler(err => {
                showError(err.message || "An error occurred during password reset.");
                resetPasswordBtnEl.innerHTML = originalText;
                resetPasswordBtnEl.disabled = false;
            })
            .resetPasswordForDemoUser();
    }

    function handleDeleteAccount() {
      const userEmail = userEmailEl.textContent.trim();
      if (!userEmail || userEmail === "N/A") {
          showError("No demo account email found to delete.");
          return;
      }

      if (confirm(`Are you sure you want to delete the demo account (${userEmail})? This action cannot be undone.`)) {
          showView('loading');
          updateLoadingStatus(`Deleting demo account ${userEmail}...`);
          google.script.run
              .withSuccessHandler(result => {
                  if (result.success) {
                    resetUi();
                  }
                  else {
                    onFailure(result.error || "Failed to delete account.");
                  }
              })
              .withFailureHandler(onFailure)
              .deleteDemoAccount(userEmail);
      }
    }
    
    function handleStartOver() {
        resetScriptGeneratorUi();
        google.script.run
            .withSuccessHandler(() => {
                console.log('Demo script data cleared on the server.');
            })
            .withFailureHandler(err => {
                console.error("Failed to clear script on server:", err);
                showError("Could not clear the previous script from the server. You can still generate a new one.");
            })
            .clearDemoScriptOnly();
    }

    function resetUi() {
        userCreationFormEl.classList.remove('hidden');
        userCredentialsDisplayEl.classList.add('hidden');
        generatorSectionEl.classList.add('hidden');
        startOverContainerEl.classList.add('hidden');
        userFirstNameInputEl.value = '';
        userLastNameInputEl.value = '';
        demoContextInputEl.value = '';
        showView('account');
    }

    function resetScriptGeneratorUi() {
        scriptResultDisplayEl.classList.add('hidden');
        demoConfigFormEl.classList.remove('hidden');
        startOverContainerEl.classList.add('hidden');
        scriptContentEl.innerHTML = '<p class="text-slate-400">Your generated script will appear here...</p>';
        demoContextInputEl.value = '';
        generatorInstructionEl.textContent = 'Your demo account is ready. Now, describe your demo objective below to generate a new script with AI.';
    }

    // --- UI Update & Rendering Functions ---
    function showView(viewName) {
      loadingIndicatorEl.classList.add('hidden');
      accountSectionEl.classList.add('hidden');
      generatorSectionEl.classList.add('hidden');
      hideError();
      mobileMenu.classList.add('hidden');
      Object.values(navLinks).flat().forEach(el => el.classList.remove('active'));

      if (viewName === 'account') {
        accountSectionEl.classList.remove('hidden');
        navLinks.account.forEach(el => el.classList.add('active'));
      } else if (viewName === 'generator') {
        generatorSectionEl.classList.remove('hidden');
        navLinks.generator.forEach(el => el.classList.add('active'));
      } else if (viewName === 'loading') {
        loadingIndicatorEl.classList.remove('hidden');
      }
    }
    
    function showGeneratorView(view) {
        scriptResultDisplayEl.classList.add('hidden');
        demoConfigFormEl.classList.add('hidden');
        scriptLoadingIndicatorEl.classList.add('hidden');
        startOverContainerEl.classList.add('hidden'); // Hide by default

        if (view === 'form') {
            demoConfigFormEl.classList.remove('hidden');
        } else if (view === 'results') {
            scriptResultDisplayEl.classList.remove('hidden');
            startOverContainerEl.classList.remove('hidden'); // Show when results are visible
        } else if (view === 'loading') {
            scriptLoadingIndicatorEl.classList.remove('hidden');
        }
    }

    function populateUserCredentials(provisionResult) {
        userFirstNameDisplayEl.textContent = provisionResult.firstName || "N/A";
        userLastNameDisplayEl.textContent = provisionResult.lastName || "N/A";
        userEmailEl.textContent = provisionResult.email || "N/A";
        userCreationFormEl.classList.add('hidden');
        userCredentialsDisplayEl.classList.remove('hidden');

        if (provisionResult.password) {
            userPasswordEl.textContent = provisionResult.password;
            resetPasswordContainerEl.classList.add('hidden');
        } else {
            userPasswordEl.textContent = '••••••••••••';
            resetPasswordContainerEl.classList.remove('hidden');
        }
        
        generatorInstructionEl.textContent = "Your demo account is ready.";
        generateBtnEl.disabled = false;
        generatorSectionEl.classList.remove('hidden'); // Make sure generator is visible
    }

    function onFailure(error) {
      showError(typeof error === 'string' ? error : error.message || "An unknown server error occurred.");
      resetUi();
    }

    function showError(message) {
      errorMessageEl.textContent = message;
      errorDisplayEl.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideError() {
      errorDisplayEl.classList.add('hidden');
    }

    function updateLoadingStatus(message) {
      loadingStatusEl.textContent = message;
    }
    
    function renderScriptFromObject(scriptObject) {
      scriptContentEl.innerHTML = '';
      const sanitize = text => typeof text === 'string' ? text.replace(/["']/g, '') : '';
      const plainFormatter = text => sanitize(text).replace(/`([^`]+)`/g, '<code>$1</code>');
      const scriptFormatter = text => `<em>"${plainFormatter(text)}"</em>`;

      if (!scriptObject || !scriptObject.title || !scriptObject.steps) {
        scriptContentEl.innerHTML = '<p class="text-red-500">Error: The AI returned an invalid script format.</p>';
        return;
      }
      
      const titleEl = document.createElement('h2');
      titleEl.className = "!text-left";
      titleEl.textContent = scriptObject.title;
      scriptContentEl.appendChild(titleEl);
 
      if (scriptObject.summary) {
        const summaryTitleEl = document.createElement('h3');
        summaryTitleEl.textContent = "Demo Summary";
        scriptContentEl.appendChild(summaryTitleEl);
        const summaryTextEl = document.createElement('p');
        summaryTextEl.textContent = sanitize(scriptObject.summary);
        scriptContentEl.appendChild(summaryTextEl);
      }

      if (scriptObject.prerequisites && scriptObject.prerequisites.length > 0) {
        const prereqsTitleEl = document.createElement('h3');
        prereqsTitleEl.textContent = "Prerequisites";
        scriptContentEl.appendChild(prereqsTitleEl);
        const prereqsListEl = document.createElement('ul');
        prereqsListEl.classList.add('list-disc', 'ml-6', 'mb-6');
        scriptObject.prerequisites.forEach(prereq => {
          const li = document.createElement('li');
          li.textContent = sanitize(prereq);
          prereqsListEl.appendChild(li);
        });
        scriptContentEl.appendChild(prereqsListEl);
      }

      if (scriptObject.introduction) {
        createBlock('Presenter Talking Script', scriptObject.introduction, 'presenter-script-block', scriptFormatter);
      }

      scriptObject.steps.forEach((step, index) => {
        const stepTitleEl = document.createElement('h3');
        stepTitleEl.textContent = step.step_title || '';
        scriptContentEl.appendChild(stepTitleEl);
        createBlock('Action', step.action, 'action-block', plainFormatter);
        createBlock('UI Interaction', step.ui_interaction, 'ui-interaction-block', plainFormatter);
        createBlock('Presenter Talking Script', step.presenter_script, 'presenter-script-block', scriptFormatter);
      });
    }
    
    function createBlock(label, content, blockClass, formatter) {
        if (!content) return;
        const pLabel = document.createElement('p');
        pLabel.className = `${blockClass} label-paragraph`;
        pLabel.innerHTML = `<strong>${label}:</strong>`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'content-block';
        const pContent = document.createElement('p');
        pContent.innerHTML = formatter(content);
        
        contentDiv.appendChild(pContent);
        scriptContentEl.appendChild(pLabel);
        scriptContentEl.appendChild(contentDiv);
    }
    
    // --- Utility Functions ---
    function copyToClipboard(text, buttonElement) {
        if (text === '••••••••••••') {
            const originalIcon = buttonElement.innerHTML;
            buttonElement.innerHTML = '<span class="material-symbols-outlined text-sm text-red-600">close</span>';
            setTimeout(() => { buttonElement.innerHTML = originalIcon; }, 1500);
            return;
        }
      navigator.clipboard.writeText(text).then(() => {
        const originalIcon = buttonElement.innerHTML;
        buttonElement.innerHTML = '<span class="material-symbols-outlined text-sm text-green-600">check_circle</span>';
        setTimeout(() => { buttonElement.innerHTML = originalIcon; }, 1500);
      }).catch(err => console.error('Failed to copy: ', err));
    }

    function copyScriptToClipboard(buttonElement) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = scriptContentEl.innerHTML;
        
        let scriptText = Array.from(tempDiv.childNodes).map(node => {
            if (node.nodeName === '#text') return ''; 
            const text = node.innerText?.trim();
            if (!text) return '';
            
            if (['H2', 'H3'].includes(node.tagName)) {
                return `\n\n${text}\n${'-'.repeat(text.length)}\n`;
            }
            if (node.tagName === 'P' && node.classList.contains('label-paragraph')) {
                return `\n${text} `;
            }
            if (node.tagName === 'DIV' && node.classList.contains('content-block')) {
                return `${text}\n`;
            }
             if (node.tagName === 'UL') {
                let listItems = Array.from(node.querySelectorAll('li')).map(li => `  • ${li.innerText.trim()}`).join('\n');
                return `${listItems}\n`;
            }
            return text;
        }).join('');
        
        navigator.clipboard.writeText(scriptText.trim()).then(() => {
            const originalHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = '<span class="material-symbols-outlined mr-1.5 text-sm text-green-600">check_circle</span> Copied!';
            buttonElement.classList.add('text-green-600');
            setTimeout(() => { 
                buttonElement.innerHTML = originalHTML; 
                buttonElement.classList.remove('text-green-600');
            }, 2000);
        }).catch(err => console.error('Failed to copy script: ', err));
    }
  </script>
</body>
</html>